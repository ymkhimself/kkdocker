# 如何实现容器的后台运行

早期的Docker，所有容器的init进程都是从docker daemon这个进程fork出来的 ，这也就会导致，如果docker
daemon挂到，所有容器都G了。后来docker使用了
containerd，low-level的实现是runC，可以实现daemon挂掉，容器仍然在。

父进程退出子进程不挂的原理：命令mydocker是主进程，创建出的子进程是我们的容器，如果父进程挂了，子进程就成了孤儿进程。为了避免无法释放他占用的资源，进程号
为1的进程init就会接受这些孤儿进程。
> 疑惑，父进程退出，子进程到底是个啥状态，前后说的好像不一样呀

# 如何实现docker ps

非常简单，Docker启动时，我们要生成docker信息，放在/var/run/mydocker 下，一个容器一个文件夹，容器要有名字

文件夹下的config.json文件储存容器的信息，包括id,pid,status,command,created等

docker ps的时候，去遍历/var/run/mydocker目录就行了

# 如何实现 docker logs

将docker容器内的标准输出重定向到一个文件，就ok了

# 如何实现 docker exec

容器创建之后，我们就无法再进入容器了，我们要怎么再次进入容器呢，这时候需要再次进入容器的namespace

## setns

setns 是一个系统调用，可以根据提供的pid再次进入指定的namespace。
但是对于go来说很麻烦，对于Mount Namespace来说，一个具有多线程的进程无法使用setns调用进入到对应的命名空间。但是Go每启动一个程序都会进入多线程
状态，因此无法简单地通过go调用这个系统调用，需要用C

## Cgo

Cgo允许Go程序去调用C的函数和标准库。你只需要以一种特殊的方式在Go的源码里面写出需要调用的c代码，Cgo就能把你的C代码和Go文件整合成一个包。

# 如何停止和删除容器

## 停止

1. 根据容器名获取pid
2. kill pid
3. 修改容器信息
4. 将容器信息写回去

## 删除

1. 根据容器名获取容器信息
2. 判断容器状态
3. 删除容器信息文件

# 通过容器制作镜像

1. 为每个容器分配单独的隔离文件系统
2. 修改commit，对不同容器进行打包

每个镜像生成一个只读层
一个容器生成一个读写层，用aufs

# 实现环境变量

run命令加一个参数 e
然后在NewParentProcess函数中这样搞

```go
cmd.Env = append(os.Environ(), envSlice...)
```

可以把我们拿到的环境变量给配到新的进程里

但是，如果是-d 模式运行，再exec进去，环境变量就不管用了，因为exec启动了一个外部的新进程，只不过namespace变进去了而已
因此，我们得修改exec命令

# 构建容器网络

## 虚拟网络设备

Linux通过网络设备操作和使用网卡，系统装了一个网卡后，会生成一个网络设备实例。

现在Linux支持创建出虚拟的设备，可以通过虚拟化设备的组合实现多种多样的功能和网络拓扑。

容器网络主要用到veth和bridge

### veth

成对出现，发送到一端的请求会从另一端出来
在容器的虚拟化场景中，经常会使用veth连接不同网络namespace

### bridge

Brid 虚拟设备是用来桥接的网络设备，它相当于现实世界中的交换机 可以连接不同的
网络设备，当请求到达 Bridge 设备时，可以通过报文中的 Mac 地址进行广播或转发。
我们可以创建一个bridge，来连接namespace中的网络设备和宿主机上的网络

## linux路由表

路由表是 Linux 内核的 个模块，通过定义路由表来决定在某个网络Namespace中包的流
向，从而定义请求会到哪个网络设备上

## linux iptables

iptables 是对 Linux 内核的 netfilter 模块进行操作和展示的工具，用来管理包的流动和转
送。 iptables 定义了一套链式处理的结构，在网络包传输的各个阶段可以使用不同的策略对包
进行加工、传送或丢弃。在容器虚拟化的技术中，经常会用到两种策略 MASQUERADE和
DNAT ，用于容器和宿主机外部的网络通信。

### MASQUERADE

iptables 中的 MASQUERADE 策略可以将请求包中的源地址转换成一个网络设备的地址

### DNAT

iptables 中的 DNAT 策略也是做网络地址的转换，不过它是要更换目标地址，经常用于将
内部网络地址的端口映射到外部去

## 网络模型

### 网络

网络是容器的一个集合，在这个网络中的容器可以互相通信，就像挂载到同一个Linux bridge设备上的网络设备一样，可以直接通过Bridge设备
实现网络互联。网络中会包含这个网络相关的配置，比如容器的网络地址段，网络操作所调用的网络驱动等信息。

### 网络端点

网络端点是用于连接容器与网络的，保证容器内部与网络的通信。
网络端点中会包括连接到网络的一些信息，比如地址、 Veth 设备、端口映射、连接的容器 网络等信息

### 网络驱动

网络驱动是一个网络功能中的组件，不同驱动对网络的创建、连接、销毁的策略不同，通过在创建网络时指定不同的网络驱动来定义使用哪个驱动做网络的配置

## 容器地址分配
